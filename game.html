<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–¢—Ä–∏ –≤ —Ä—è–¥ –¥–ª—è –£–º–Ω–∏—á–∫–∏! üí´</title>
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    rel="stylesheet"
  >
  <link
    href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Montserrat:wght@300;400;600&display=swap"
    rel="stylesheet"
  >
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="game_style.css">
</head>

<body>
  <!-- –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ–Ω -->
  <div class="animated-bg">
    <div class="bg-shapes">
      <div class="shape shape-1"></div>
      <div class="shape shape-2"></div>
      <div class="shape shape-3"></div>
      <div class="shape shape-4"></div>
    </div>
  </div>

  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–≥—Ä—ã -->
  <div class="game-container">
    <h1 class="game-title">–¢—Ä–∏ –≤ —Ä—è–¥! üíñ</h1>

    <div class="game-stats">
      <div class="stat-item">
        <div class="stat-value" id="score">0</div>
        <div>–û—á–∫–∏</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="combinations">0</div>
        <div>–ö–æ–º–±–∏–Ω–∞—Ü–∏–∏</div>
      </div>
    </div>

    <div class="game-board" id="gameBoard"></div>

    <div class="game-controls">
      <button class="game-button" id="hintButton">–ü–æ–¥—Å–∫–∞–∑–∫–∞ üí°</button>
      <button class="game-button" id="restartButton">–ó–∞–Ω–æ–≤–æ üîÑ</button>
    </div>

    <a href="index.html" class="back-button">
      <i class="fas fa-arrow-left"></i> –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥
    </a>
  </div>

  <!-- –°–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç–æ–º -->
  <div class="compliment-message" id="complimentMessage">
    <div class="message-heart">üíñ</div>
    <h3 id="complimentText">–ú–æ–ª–æ–¥–µ—Ü! –¢—ã –ø—Ä–æ—Å—Ç–æ —É–º–Ω–∏—á–∫–∞! ‚ú®</h3>
  </div>

  <!-- –ü–ª–∞–≤–∞—é—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã -->
  <div class="floating-elements">
    <div class="floating-element fe-1">üíñ</div>
    <div class="floating-element fe-2">‚ú®</div>
    <div class="floating-element fe-3">üåü</div>
    <div class="floating-element fe-4">üéÄ</div>
    <div class="floating-element fe-5">üíï</div>
  </div>

  <script>
    class Match3Game {
      constructor() {
        this.boardSize = 8;
        this.cellTypes = ['üíñ', '‚ú®', 'üåü', 'üéÄ', 'üíï', 'üå∏'];
        this.board = [];
        this.selectedCell = null;
        this.score = 0;
        this.combinations = 0;
        this.isSwapping = false;

        this.compliments = [
          "–ú–æ–ª–æ–¥–µ—Ü! –¢—ã –ø—Ä–æ—Å—Ç–æ —É–º–Ω–∏—á–∫–∞! ‚ú®",
          "–í–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ! –¢—ã —Å–ø—Ä–∞–≤–ª—è–µ—à—å—Å—è –ø—Ä–æ—Å—Ç–æ –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ! üí´",
          "–ü–æ—Ç—Ä—è—Å–∞—é—â–µ! –£ —Ç–µ–±—è –æ—Ç–ª–∏—á–Ω–æ –ø–æ–ª—É—á–∞–µ—Ç—Å—è! üå∏",
          "–ë—Ä–∞–≤–æ! –¢–≤–æ–∏ –Ω–∞–≤—ã–∫–∏ –≤–ø–µ—á–∞—Ç–ª—è—é—Ç! üíñ",
          "–ó–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ! –¢—ã –Ω–∞—Ö–æ–¥–∏—à—å –ª—É—á—à–∏–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏! üåü",
          "–ò–¥–µ–∞–ª—å–Ω–æ! –¢—ã —Ä–æ–∂–¥–µ–Ω–∞ –¥–ª—è —ç—Ç–æ–π –∏–≥—Ä—ã! üíï",
          "–ü—Ä–µ–≤–æ—Å—Ö–æ–¥–Ω–æ! –¢–≤–æ—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑—É–ø—Ä–µ—á–Ω–æ! üéÄ",
          "–§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞! –¢—ã –¥–µ–ª–∞–µ—à—å —ç—Ç–æ —Ç–∞–∫ –ª–µ–≥–∫–æ –∏ –∏–∑—è—â–Ω–æ! ‚ú®"
        ];

        this.init();
      }

      init() {
        this.createBoard();
        this.renderBoard();
        this.setupEventListeners();
        this.updateStats();
      }

      createBoard() {
        this.board = [];
        for (let i = 0; i < this.boardSize; i++) {
          this.board[i] = [];
          for (let j = 0; j < this.boardSize; j++) {
            this.board[i][j] = this.getRandomCellType();
          }
        }

        // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –Ω–∞ –¥–æ—Å–∫–µ –Ω–µ—Ç –Ω–∞—á–∞–ª—å–Ω—ã—Ö –∫–æ–º–±–∏–Ω–∞—Ü–∏–π
        while (this.findAllMatches().length > 0) {
          this.shuffleBoard();
        }
      }

      getRandomCellType() {
        return this.cellTypes[Math.floor(Math.random() * this.cellTypes.length)];
      }

      renderBoard() {
        const gameBoard = document.getElementById('gameBoard');
        gameBoard.innerHTML = '';

        for (let i = 0; i < this.boardSize; i++) {
          for (let j = 0; j < this.boardSize; j++) {
            const cell = document.createElement('div');
            cell.className = 'game-cell';
            cell.textContent = this.board[i][j];
            cell.dataset.row = i;
            cell.dataset.col = j;

            cell.addEventListener('click', () => this.handleCellClick(i, j));

            gameBoard.appendChild(cell);
          }
        }
      }

      setupEventListeners() {
        document.getElementById('hintButton').addEventListener('click', () => {
          this.showHint();
        });

        document.getElementById('restartButton').addEventListener('click', () => {
          this.restartGame();
        });
      }

      handleCellClick(row, col) {
        if (this.isSwapping) return;

        const cellElement = this.getCellElement(row, col);

        if (!this.selectedCell) {
          // –ü–µ—Ä–≤–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ
          this.selectedCell = { row, col };
          cellElement.classList.add('selected');
        } else {
          // –í—Ç–æ—Ä–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ - –ø–æ–ø—ã—Ç–∫–∞ –æ–±–º–µ–Ω–∞
          const firstCell = this.selectedCell;

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è—é—Ç—Å—è –ª–∏ —è—á–µ–π–∫–∏ —Å–æ—Å–µ–¥—è–º–∏
          if (this.areNeighbors(firstCell.row, firstCell.col, row, col)) {
            this.swapCells(firstCell.row, firstCell.col, row, col);
          }

          // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
          this.getCellElement(firstCell.row, firstCell.col).classList.remove('selected');
          this.selectedCell = null;
        }
      }

      areNeighbors(row1, col1, row2, col2) {
        const rowDiff = Math.abs(row1 - row2);
        const colDiff = Math.abs(col1 - col2);
        return (rowDiff === 1 && colDiff === 0) || (rowDiff === 0 && colDiff === 1);
      }

      swapCells(row1, col1, row2, col2) {
        this.isSwapping = true;

        // –ú–µ–Ω—è–µ–º –º–µ—Å—Ç–∞–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ –¥–æ—Å–∫–µ
        const temp = this.board[row1][col1];
        this.board[row1][col1] = this.board[row2][col2];
        this.board[row2][col2] = temp;

        this.renderBoard();

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ–±—Ä–∞–∑–æ–≤–∞–ª–∏—Å—å –ª–∏ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏
        setTimeout(() => {
          const matches = this.findAllMatches();
          if (matches.length > 0) {
            this.processMatches(matches);
          } else {
            // –ï—Å–ª–∏ –∫–æ–º–±–∏–Ω–∞—Ü–∏–π –Ω–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ
            const temp = this.board[row1][col1];
            this.board[row1][col1] = this.board[row2][col2];
            this.board[row2][col2] = temp;
            this.renderBoard();
          }
          this.isSwapping = false;
        }, 300);
      }

      findAllMatches() {
        const matches = [];

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
        for (let i = 0; i < this.boardSize; i++) {
          for (let j = 0; j < this.boardSize - 2; j++) {
            if (this.board[i][j] !== '' &&
              this.board[i][j] === this.board[i][j + 1] &&
              this.board[i][j] === this.board[i][j + 2]) {

              // –ù–∞—Ö–æ–¥–∏–º –≤—Å—é –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å
              let k = j + 3;
              while (k < this.boardSize && this.board[i][j] === this.board[i][k]) {
                k++;
              }

              const match = [];
              for (let l = j; l < k; l++) {
                match.push({ row: i, col: l });
              }
              matches.push(match);
              j = k - 1;
            }
          }
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
        for (let j = 0; j < this.boardSize; j++) {
          for (let i = 0; i < this.boardSize - 2; i++) {
            if (this.board[i][j] !== '' &&
              this.board[i][j] === this.board[i + 1][j] &&
              this.board[i][j] === this.board[i + 2][j]) {

              // –ù–∞—Ö–æ–¥–∏–º –≤—Å—é –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å
              let k = i + 3;
              while (k < this.boardSize && this.board[i][j] === this.board[k][j]) {
                k++;
              }

              const match = [];
              for (let l = i; l < k; l++) {
                match.push({ row: l, col: j });
              }
              matches.push(match);
              i = k - 1;
            }
          }
        }

        return matches;
      }

      processMatches(matches) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏
        matches.forEach((match, index) => {
          setTimeout(() => {
            this.showCompliment();
            this.combinations++;
            this.score += match.length * 10;
            this.updateStats();

            // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —Å–æ–≤–ø–∞–≤—à–∏–µ —è—á–µ–π–∫–∏
            match.forEach(cell => {
              const cellElement = this.getCellElement(cell.row, cell.col);
              cellElement.classList.add('matched');
            });
          }, index * 200);
        });

        // –£–¥–∞–ª—è–µ–º —Å–æ–≤–ø–∞–≤—à–∏–µ —è—á–µ–π–∫–∏ –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º –Ω–æ–≤—ã–º–∏
        setTimeout(() => {
          this.removeMatches(matches);
          this.fillBoard();
          this.renderBoard();

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞—Å–∫–∞–¥–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
          setTimeout(() => {
            const newMatches = this.findAllMatches();
            if (newMatches.length > 0) {
              this.processMatches(newMatches);
            }
          }, 500);
        }, matches.length * 200);
      }

      removeMatches(matches) {
        const cellsToRemove = new Set();

        matches.forEach(match => {
          match.forEach(cell => {
            cellsToRemove.add(`${cell.row},${cell.col}`);
            this.board[cell.row][cell.col] = '';
          });
        });
      }

      fillBoard() {
        // –û–ø—É—Å–∫–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –≤–Ω–∏–∑
        for (let j = 0; j < this.boardSize; j++) {
          let emptySpaces = 0;

          // –°—á–∏—Ç–∞–µ–º —Å–Ω–∏–∑—É –≤–≤–µ—Ä—Ö
          for (let i = this.boardSize - 1; i >= 0; i--) {
            if (this.board[i][j] === '') {
              emptySpaces++;
            } else if (emptySpaces > 0) {
              this.board[i + emptySpaces][j] = this.board[i][j];
              this.board[i][j] = '';
            }
          }

          // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø—É—Å—Ç—ã–µ –º–µ—Å—Ç–∞ —Å–≤–µ—Ä—Ö—É
          for (let i = 0; i < emptySpaces; i++) {
            this.board[i][j] = this.getRandomCellType();
          }
        }
      }

      showCompliment() {
        const randomCompliment = this.compliments[Math.floor(Math.random() * this.compliments.length)];
        const message = document.getElementById('complimentMessage');
        const text = document.getElementById('complimentText');

        text.textContent = randomCompliment;
        message.classList.add('show');

        setTimeout(() => {
          message.classList.remove('show');
        }, 2000);
      }

      showHint() {
        const matches = this.findAllMatches();
        if (matches.length > 0) {
          // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –ø–µ—Ä–≤—É—é –Ω–∞–π–¥–µ–Ω–Ω—É—é –∫–æ–º–±–∏–Ω–∞—Ü–∏—é
          const firstMatch = matches[0];
          firstMatch.forEach(cell => {
            const cellElement = this.getCellElement(cell.row, cell.col);
            cellElement.style.background = 'rgba(255, 215, 0, 0.5)';

            setTimeout(() => {
              cellElement.style.background = '';
            }, 1000);
          });
        } else {
          this.showCompliment();
        }
      }

      shuffleBoard() {
        // –ü—Ä–æ—Å—Ç–æ–π –∞–ª–≥–æ—Ä–∏—Ç–º –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏—è
        for (let i = this.boardSize - 1; i > 0; i--) {
          for (let j = this.boardSize - 1; j > 0; j--) {
            const randomI = Math.floor(Math.random() * (i + 1));
            const randomJ = Math.floor(Math.random() * (j + 1));

            const temp = this.board[i][j];
            this.board[i][j] = this.board[randomI][randomJ];
            this.board[randomI][randomJ] = temp;
          }
        }

        this.renderBoard();
      }

      restartGame() {
        this.score = 0;
        this.combinations = 0;
        this.selectedCell = null;
        this.createBoard();
        this.renderBoard();
        this.updateStats();
      }

      getCellElement(row, col) {
        return document.querySelector(`.game-cell[data-row="${row}"][data-col="${col}"]`);
      }

      updateStats() {
        document.getElementById('score').textContent = this.score;
        document.getElementById('combinations').textContent = this.combinations;
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
    document.addEventListener('DOMContentLoaded', () => {
      new Match3Game();
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
    document.addEventListener('DOMContentLoaded', () => {
      if (window.Telegram && Telegram.WebApp) {
        const tg = Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();
        tg.setHeaderColor('#667eea');
        tg.setBackgroundColor('#667eea');
      }
    });
  </script>
</body>

</html>